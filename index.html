<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcador Torneo de Ping Pong</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-image: linear-gradient(rgba(15, 41, 59, 0.9), rgba(13, 79, 78, 0.9)), url('https://raw.githubusercontent.com/Jjordaz22964692/Ping-Pong/main/imagenes/photo-1511067007398-7e4b90cfa4bc.avif');
            background-color: #0f293b;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #F9FAFB;
        }
        h1, h3 {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        .bracket-container {
            position: relative;
            display: flex;
            justify-content: center;
            padding: 2rem;
            overflow-x: auto;
            transition: opacity 0.5s ease-out;
        }
        .bracket {
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .bracket-wing {
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .bracket-wing.right {
            flex-direction: row-reverse;
        }
        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            flex-grow: 1;
            min-width: 260px; /* Optimizado para 2K */
            padding: 0 2.5rem;
        }
        .round-final { min-width: 340px; }
        .match {
            background-color: rgba(31, 41, 55, 0.85);
            border-radius: 0.75rem;
            margin: 3rem 0;
            padding: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 2px solid transparent;
            backdrop-filter: blur(10px);
            cursor: pointer;
            width: 100%;
        }
        .match.disappearing {
            transform: scale(0);
            opacity: 0;
        }
        .match-completed { border-color: #4b5563; }
        .match.is-focus-mode {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(2.5);
            z-index: 100; border-color: #f59e0b;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            cursor: default; width: 90%; max-width: 400px;
        }
        .player {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 0; border-bottom: 1px solid #4b5563;
        }
        .player:last-child { border-bottom: none; }
        .player-name { 
            font-weight: 500; flex-grow: 1; font-size: 1rem;
            padding: 2px 4px; border-radius: 3px;
            transition: background-color 0.2s;
        }
        .player-name:hover { background-color: rgba(255,255,255,0.1); }
        .player-name[contenteditable="true"] {
            background-color: #4b5563; outline: 2px solid #f59e0b; cursor: text;
        }
        .winner-highlight { animation: glow 1.5s ease-in-out infinite alternate; }
        @keyframes glow {
            from { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #00ffc3, 0 0 20px #00ffc3; }
            to { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #00ffc3, 0 0 40px #00ffc3; }
        }
        .player-score {
            font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 700;
            margin-left: 1rem; width: 40px; text-align: center; color: #f59e0b;
        }
        .score-controls button {
            background-color: #4b5563; border: none; color: white; border-radius: 9999px;
            width: 32px; height: 32px; font-size: 1.2rem; line-height: 1;
            margin-left: 0.5rem; cursor: pointer; transition: all 0.2s ease;
        }
        .score-controls button:hover { background-color: #6b7280; transform: scale(1.1); }
        .winner-button {
            background: linear-gradient(to right, #10b981, #14b8a6); color: white; border: none;
            padding: 0.75rem 1rem; border-radius: 0.375rem; margin-top: 1rem; cursor: pointer;
            width: 100%; font-weight: 700; font-size: 1rem; text-transform: uppercase;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .winner-button:hover { transform: translateY(-2px); box-shadow: 0 7px 10px rgba(0,0,0,0.2); }
        .winner-button:disabled { background: #4b5563; cursor: not-allowed; transform: none; box-shadow: none; }
        .logo-container {
            display: flex; justify-content: center; align-items: center;
            gap: 4rem; margin-bottom: 2rem;
        }
        .logo-container img {
            height: 135px; /* 90px * 1.5 */
            width: auto; object-fit: contain;
            max-width: 375px; filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.3));
        }
        .vs { font-family: 'Orbitron', sans-serif; font-size: 4rem; font-weight: 900; color: #d1d5db; text-shadow: 3px 3px 5px rgba(0,0,0,0.5); }
        #backdrop, #winner-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.7); z-index: 50; opacity: 0;
            transition: opacity 0.4s ease; pointer-events: none;
        }
        #backdrop.active, #winner-overlay.active { opacity: 1; pointer-events: auto; }
        #fireworks-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200; pointer-events: none;
        }
        #connector-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
        }
        #winner-overlay {
            z-index: 300;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #winner-name {
            font-size: 8vw;
            font-family: 'Orbitron', sans-serif;
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        #winner-title {
            font-size: 4vw;
            color: #f59e0b;
        }
        #summary-container {
            display: none; /* Inicia oculto */
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }
        .summary-match {
            border: 2px solid #4b5563;
            opacity: 0.7;
        }
        .summary-match .player-name {
            font-weight: normal;
        }
        .summary-match .winner {
            font-weight: bold;
            color: #10b981;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <canvas id="fireworks-canvas"></canvas>
    <div id="backdrop"></div>
    <div id="winner-overlay">
        <div>
            <h2 id="winner-name"></h2>
            <p id="winner-title">¡CAMPEÓN!</p>
        </div>
    </div>

    <header class="text-center my-8">
        <div class="logo-container">
             <img src="https://i.imgur.com/8a5a3FS.png" alt="Andromeda Ventures Logo" onerror="this.onerror=null;this.src='https://placehold.co/200x70/0f293b/FFFFFF?text=Andromeda';">
             <span class="vs">VS</span>
             <img src="https://raw.githubusercontent.com/Jjordaz22964692/Ping-Pong/main/imagenes/pngwing.com.png" alt="Nestlé Logo" onerror="this.onerror=null;this.src='https://placehold.co/200x70/0f293b/FFFFFF?text=Nestlé';">
        </div>
        <h1 class="text-5xl sm:text-6xl font-black tracking-wider uppercase">Torneo de Ping Pong</h1>
    </header>

    <div class="bracket-container" id="bracket-container">
        <svg id="connector-svg"></svg>
        <div class="bracket" id="bracket">
            <!-- Bracket structure remains the same -->
            <div class="bracket-wing left">
                <div class="round">
                    <div class="match" data-match-id="1" data-next-match="9" data-next-player-slot="1" onclick="focusMatch(event)"><div class="player"><span class="player-name" ondblclick="editName(this)">Alejandra G. - Ricardo P.</span><div class="score-controls"><button onclick="changeScore(1, 1, -1)">-</button><span class="player-score" id="score-1-1">0</span><button onclick="changeScore(1, 1, 1)">+</button></div></div><div class="player"><span class="player-name" ondblclick="editName(this)">Justin J. - Kender P.</span><div class="score-controls"><button onclick="changeScore(1, 2, -1)">-</button><span class="player-score" id="score-1-2">0</span><button onclick="changeScore(1, 2, 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(1, event)" disabled>Ganador</button></div>
                    <div class="match" data-match-id="2" data-next-match="9" data-next-player-slot="2" onclick="focusMatch(event)"><div class="player"><span class="player-name" ondblclick="editName(this)">Cecilia B. - Valeria O.</span><div class="score-controls"><button onclick="changeScore(2, 3, -1)">-</button><span class="player-score" id="score-2-3">0</span><button onclick="changeScore(2, 3, 1)">+</button></div></div><div class="player"><span class="player-name" ondblclick="editName(this)">Feliciano G. - Pedro C.</span><div class="score-controls"><button onclick="changeScore(2, 4, -1)">-</button><span class="player-score" id="score-2-4">0</span><button onclick="changeScore(2, 4, 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(2, event)" disabled>Ganador</button></div>
                    <div class="match" data-match-id="3" data-next-match="10" data-next-player-slot="1" onclick="focusMatch(event)"><div class="player"><span class="player-name" ondblclick="editName(this)">Gisanny M. - Mariam M.</span><div class="score-controls"><button onclick="changeScore(3, 5, -1)">-</button><span class="player-score" id="score-3-5">0</span><button onclick="changeScore(3, 5, 1)">+</button></div></div><div class="player"><span class="player-name" ondblclick="editName(this)">Vanesa C. - Iván L.</span><div class="score-controls"><button onclick="changeScore(3, 6, -1)">-</button><span class="player-score" id="score-3-6">0</span><button onclick="changeScore(3, 6, 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(3, event)" disabled>Ganador</button></div>
                    <div class="match" data-match-id="4" data-next-match="10" data-next-player-slot="2" onclick="focusMatch(event)"><div class="player"><span class="player-name" ondblclick="editName(this)">Andrés D. - Vicente O.</span><div class="score-controls"><button onclick="changeScore(4, 7, -1)">-</button><span class="player-score" id="score-4-7">0</span><button onclick="changeScore(4, 7, 1)">+</button></div></div><div class="player"><span class="player-name" ondblclick="editName(this)">Lui H. - Jesús G.</span><div class="score-controls"><button onclick="changeScore(4, 8, -1)">-</button><span class="player-score" id="score-4-8">0</span><button onclick="changeScore(4, 8, 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(4, event)" disabled>Ganador</button></div>
                </div>
                <div class="round">
                    <div class="match" data-match-id="9" data-next-match="13" data-next-player-slot="1" onclick="focusMatch(event)"><div class="player" data-player-id="9-1"><span class="player-name" ondblclick="editName(this)">Ganador M1</span><div class="score-controls"><button onclick="changeScore(9, '9-1', -1)">-</button><span class="player-score" id="score-9-9-1">0</span><button onclick="changeScore(9, '9-1', 1)">+</button></div></div><div class="player" data-player-id="9-2"><span class="player-name" ondblclick="editName(this)">Ganador M2</span><div class="score-controls"><button onclick="changeScore(9, '9-2', -1)">-</button><span class="player-score" id="score-9-9-2">0</span><button onclick="changeScore(9, '9-2', 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(9, event)" disabled>Ganador</button></div>
                    <div class="match" data-match-id="10" data-next-match="13" data-next-player-slot="2" onclick="focusMatch(event)"><div class="player" data-player-id="10-1"><span class="player-name" ondblclick="editName(this)">Ganador M3</span><div class="score-controls"><button onclick="changeScore(10, '10-1', -1)">-</button><span class="player-score" id="score-10-10-1">0</span><button onclick="changeScore(10, '10-1', 1)">+</button></div></div><div class="player" data-player-id="10-2"><span class="player-name" ondblclick="editName(this)">Ganador M4</span><div class="score-controls"><button onclick="changeScore(10, '10-2', -1)">-</button><span class="player-score" id="score-10-10-2">0</span><button onclick="changeScore(10, '10-2', 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(10, event)" disabled>Ganador</button></div>
                </div>
                <div class="round">
                    <div class="match" data-match-id="13" data-next-match="15" data-next-player-slot="1" data-loser-to="16" data-loser-slot="1" onclick="focusMatch(event)"><div class="player" data-player-id="13-1"><span class="player-name" ondblclick="editName(this)">Ganador QF1</span><div class="score-controls"><button onclick="changeScore(13, '13-1', -1)">-</button><span class="player-score" id="score-13-13-1">0</span><button onclick="changeScore(13, '13-1', 1)">+</button></div></div><div class="player" data-player-id="13-2"><span class="player-name" ondblclick="editName(this)">Ganador QF2</span><div class="score-controls"><button onclick="changeScore(13, '13-2', -1)">-</button><span class="player-score" id="score-13-13-2">0</span><button onclick="changeScore(13, '13-2', 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(13, event)" disabled>Ganador</button></div>
                </div>
            </div>
            <div class="round round-final">
                <div class="match" data-match-id="15" onclick="focusMatch(event)"><h3 class="text-2xl font-bold text-center mb-4 text-yellow-400 uppercase">Gran Final</h3><div class="player" data-player-id="15-1"><span class="player-name" ondblclick="editName(this)">Ganador SF1</span><div class="score-controls"><button onclick="changeScore(15, '15-1', -1)">-</button><span class="player-score" id="score-15-15-1">0</span><button onclick="changeScore(15, '15-1', 1)">+</button></div></div><div class="player" data-player-id="15-2"><span class="player-name" ondblclick="editName(this)">Ganador SF2</span><div class="score-controls"><button onclick="changeScore(15, '15-2', -1)">-</button><span class="player-score" id="score-15-15-2">0</span><button onclick="changeScore(15, '15-2', 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(15, event)" disabled>Declarar Campeón</button></div>
                <div class="match" data-match-id="16" onclick="focusMatch(event)"><h3 class="text-xl font-bold text-center mb-2 text-orange-400 uppercase">Tercer Lugar</h3><div class="player" data-player-id="16-1"><span class="player-name" ondblclick="editName(this)">Perdedor SF1</span><div class="score-controls"><button onclick="changeScore(16, '16-1', -1)">-</button><span class="player-score" id="score-16-16-1">0</span><button onclick="changeScore(16, '16-1', 1)">+</button></div></div><div class="player" data-player-id="16-2"><span class="player-name" ondblclick="editName(this)">Perdedor SF2</span><div class="score-controls"><button onclick="changeScore(16, '16-2', -1)">-</button><span class="player-score" id="score-16-16-2">0</span><button onclick="changeScore(16, '16-2', 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(16, event)" disabled>Declarar 3er Lugar</button></div>
            </div>
            <div class="bracket-wing right">
                <div class="round">
                    <div class="match" data-match-id="14" data-next-match="15" data-next-player-slot="2" data-loser-to="16" data-loser-slot="2" onclick="focusMatch(event)"><div class="player" data-player-id="14-1"><span class="player-name" ondblclick="editName(this)">Ganador QF3</span><div class="score-controls"><button onclick="changeScore(14, '14-1', -1)">-</button><span class="player-score" id="score-14-14-1">0</span><button onclick="changeScore(14, '14-1', 1)">+</button></div></div><div class="player" data-player-id="14-2"><span class="player-name" ondblclick="editName(this)">Ganador QF4</span><div class="score-controls"><button onclick="changeScore(14, '14-2', -1)">-</button><span class="player-score" id="score-14-14-2">0</span><button onclick="changeScore(14, '14-2', 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(14, event)" disabled>Ganador</button></div>
                </div>
                <div class="round">
                    <div class="match" data-match-id="11" data-next-match="14" data-next-player-slot="1" onclick="focusMatch(event)"><div class="player" data-player-id="11-1"><span class="player-name" ondblclick="editName(this)">Ganador M5</span><div class="score-controls"><button onclick="changeScore(11, '11-1', -1)">-</button><span class="player-score" id="score-11-11-1">0</span><button onclick="changeScore(11, '11-1', 1)">+</button></div></div><div class="player" data-player-id="11-2"><span class="player-name" ondblclick="editName(this)">Ganador M6</span><div class="score-controls"><button onclick="changeScore(11, '11-2', -1)">-</button><span class="player-score" id="score-11-11-2">0</span><button onclick="changeScore(11, '11-2', 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(11, event)" disabled>Ganador</button></div>
                    <div class="match" data-match-id="12" data-next-match="14" data-next-player-slot="2" onclick="focusMatch(event)"><div class="player" data-player-id="12-1"><span class="player-name" ondblclick="editName(this)">Ganador M7</span><div class="score-controls"><button onclick="changeScore(12, '12-1', -1)">-</button><span class="player-score" id="score-12-12-1">0</span><button onclick="changeScore(12, '12-1', 1)">+</button></div></div><div class="player" data-player-id="12-2"><span class="player-name" ondblclick="editName(this)">Ganador M8</span><div class="score-controls"><button onclick="changeScore(12, '12-2', -1)">-</button><span class="player-score" id="score-12-12-2">0</span><button onclick="changeScore(12, '12-2', 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(12, event)" disabled>Ganador</button></div>
                </div>
                <div class="round">
                    <div class="match" data-match-id="5" data-next-match="11" data-next-player-slot="1" onclick="focusMatch(event)"><div class="player"><span class="player-name" ondblclick="editName(this)">Angel B. - Samuel D.</span><div class="score-controls"><button onclick="changeScore(5, 9, -1)">-</button><span class="player-score" id="score-5-9">0</span><button onclick="changeScore(5, 9, 1)">+</button></div></div><div class="player"><span class="player-name" ondblclick="editName(this)">Alexis R. - Arturo B.</span><div class="score-controls"><button onclick="changeScore(5, 10, -1)">-</button><span class="player-score" id="score-5-10">0</span><button onclick="changeScore(5, 10, 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(5, event)" disabled>Ganador</button></div>
                    <div class="match" data-match-id="6" data-next-match="11" data-next-player-slot="2" onclick="focusMatch(event)"><div class="player"><span class="player-name" ondblclick="editName(this)">Verónica S. - Enrique J.</span><div class="score-controls"><button onclick="changeScore(6, 11, -1)">-</button><span class="player-score" id="score-6-11">0</span><button onclick="changeScore(6, 11, 1)">+</button></div></div><div class="player"><span class="player-name" ondblclick="editName(this)">Ruben L. - Ricardo F.</span><div class="score-controls"><button onclick="changeScore(6, 12, -1)">-</button><span class="player-score" id="score-6-12">0</span><button onclick="changeScore(6, 12, 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(6, event)" disabled>Ganador</button></div>
                    <div class="match" data-match-id="7" data-next-match="12" data-next-player-slot="1" onclick="focusMatch(event)"><div class="player"><span class="player-name" ondblclick="editName(this)">Katiuska R. - Miguel P.</span><div class="score-controls"><button onclick="changeScore(7, 13, -1)">-</button><span class="player-score" id="score-7-13">0</span><button onclick="changeScore(7, 13, 1)">+</button></div></div><div class="player"><span class="player-name" ondblclick="editName(this)">Alejandro M. - Ricardo C.</span><div class="score-controls"><button onclick="changeScore(7, 14, -1)">-</button><span class="player-score" id="score-7-14">0</span><button onclick="changeScore(7, 14, 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(7, event)" disabled>Ganador</button></div>
                    <div class="match" data-match-id="8" data-next-match="12" data-next-player-slot="2" onclick="focusMatch(event)"><div class="player"><span class="player-name" ondblclick="editName(this)">Isabella R. - Anthony M.</span><div class="score-controls"><button onclick="changeScore(8, 15, -1)">-</button><span class="player-score" id="score-8-15">0</span><button onclick="changeScore(8, 15, 1)">+</button></div></div><div class="player"><span class="player-name" ondblclick="editName(this)">Gabriel C. - José P.</span><div class="score-controls"><button onclick="changeScore(8, 16, -1)">-</button><span class="player-score" id="score-8-16">0</span><button onclick="changeScore(8, 16, 1)">+</button></div></div><button class="winner-button" onclick="declareWinner(8, event)" disabled>Ganador</button></div>
                </div>
            </div>

        </div>
    </div>

    <div id="summary-container" class="bracket-container"></div>
    
    <script>
        const WINNING_SCORE = 11;
        const backdrop = document.getElementById('backdrop');
        let completedMatches = [];
        const initialBracketHTML = document.getElementById('bracket').innerHTML;

        function editName(element) {
            element.setAttribute('contenteditable', 'true');
            element.focus();
            const range = document.createRange();
            range.selectNodeContents(element);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);

            element.onkeydown = (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    element.blur();
                }
            };
            element.onblur = () => {
                element.setAttribute('contenteditable', 'false');
            };
        }

        function focusMatch(event) {
            if (event.target.tagName === 'BUTTON' || event.target.parentElement.classList.contains('score-controls') || event.target.isContentEditable) {
                event.stopPropagation();
                return;
            }
            const matchElement = event.currentTarget;
            if (matchElement.classList.contains('is-focus-mode')) return;
            unfocusAllMatches();
            matchElement.classList.add('is-focus-mode');
            backdrop.classList.add('active');
        }

        function unfocusAllMatches() {
            document.querySelectorAll('.is-focus-mode').forEach(el => el.classList.remove('is-focus-mode'));
            backdrop.classList.remove('active');
        }
        
        backdrop.addEventListener('click', unfocusAllMatches);

        function changeScore(matchId, playerId, delta) {
            const scoreElement = document.getElementById(`score-${matchId}-${playerId}`);
            let newScore = parseInt(scoreElement.textContent) + delta;
            if (newScore >= 0) scoreElement.textContent = newScore;
            checkWinnerCondition(matchId);
        }

        function checkWinnerCondition(matchId) {
            const matchElement = document.querySelector(`[data-match-id='${matchId}']`);
            const players = matchElement.querySelectorAll('.player');
            const scores = Array.from(players).map(p => parseInt(p.querySelector('.player-score').textContent));
            const winnerButton = matchElement.querySelector('.winner-button');
            const [p1Score, p2Score] = scores;
            
            let hasWinner = (p1Score >= WINNING_SCORE && p1Score >= p2Score + 2) || (p2Score >= WINNING_SCORE && p2Score >= p1Score + 2);
            winnerButton.disabled = !hasWinner;
        }

        function declareWinner(matchId, event) {
            const matchElement = document.querySelector(`[data-match-id='${matchId}']`);
            if (matchElement.classList.contains('match-completed')) return;

            const players = matchElement.querySelectorAll('.player');
            const scores = Array.from(players).map(p => parseInt(p.querySelector('.player-score').textContent));
            
            const winner = scores[0] > scores[1] ? players[0] : players[1];
            const loser = scores[0] > scores[1] ? players[1] : players[0];
            const winnerNameEl = winner.querySelector('.player-name');

            // Capturar datos antes de modificar
            const matchData = {
                id: matchId,
                players: Array.from(players).map((p, index) => ({
                    name: p.querySelector('.player-name').textContent,
                    score: scores[index],
                    isWinner: p === winner
                }))
            };
            completedMatches.push(matchData);

            winner.classList.add('bg-green-600/30', 'font-bold');
            winnerNameEl.classList.add('winner-highlight');
            loser.classList.add('bg-red-600/30', 'opacity-60');
            matchElement.classList.add('match-completed');
            
            matchElement.querySelectorAll('button').forEach(btn => btn.disabled = true);
            matchElement.querySelector('.winner-button').textContent = "Finalizado";

            const rect = winnerNameEl.getBoundingClientRect();
            launchFireworks(rect.left + rect.width / 2, rect.top + rect.height / 2, 1);

            const { nextMatch, nextPlayerSlot, loserTo, loserSlot } = matchElement.dataset;

            if (nextMatch && nextPlayerSlot) {
                const nextPlayerElement = document.querySelector(`[data-match-id='${nextMatch}'] [data-player-id='${nextMatch}-${nextPlayerSlot}'] .player-name`);
                if (nextPlayerElement) nextPlayerElement.textContent = winnerNameEl.textContent;
            }
            
            if(loserTo && loserSlot) {
                 const thirdPlaceMatch = document.querySelector(`[data-match-id='${loserTo}']`);
                 const thirdPlaceSlot = thirdPlaceMatch.querySelector(`[data-player-id='${loserTo}-${loserSlot}'] .player-name`);
                 if(thirdPlaceSlot) {
                     thirdPlaceSlot.textContent = loser.querySelector('.player-name').textContent;
                 }
            }
            
            setTimeout(() => {
                if (matchId != 15 && matchId != 16) { // No desaparecer la final
                    matchElement.classList.add('disappearing');
                }
                drawConnectors();
            }, 500);

            if (matchId == 15) { // Es la final
                showGrandFinale(winnerNameEl.textContent);
            }
        }

        function showGrandFinale(winnerName) {
            const overlay = document.getElementById('winner-overlay');
            document.getElementById('winner-name').textContent = winnerName;
            overlay.classList.add('active');
            
            // Fuegos artificiales intensos
            for(let i = 0; i < 5; i++){
                setTimeout(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * window.innerHeight / 2;
                    launchFireworks(x, y, 2);
                }, i * 500);
            }

            setTimeout(() => {
                overlay.classList.remove('active');
                showFinalSummary();
            }, 5000); // Mostrar por 5 segundos
        }

        function showFinalSummary() {
            const bracketContainer = document.getElementById('bracket-container');
            const summaryContainer = document.getElementById('summary-container');
            
            bracketContainer.style.opacity = '0';
            summaryContainer.style.display = 'flex';
            
            const summaryBracket = document.createElement('div');
            summaryBracket.className = 'bracket';
            summaryBracket.innerHTML = initialBracketHTML;
            summaryContainer.appendChild(summaryBracket);

            // Limpiar y poblar con datos guardados
            summaryBracket.querySelectorAll('.match').forEach(match => {
                const matchId = match.dataset.matchId;
                const matchData = completedMatches.find(m => m.id == matchId);

                if (matchData) {
                    const playerElements = match.querySelectorAll('.player');
                    playerElements.forEach((playerEl, index) => {
                        const nameEl = playerEl.querySelector('.player-name');
                        const scoreEl = playerEl.querySelector('.player-score');
                        nameEl.textContent = matchData.players[index].name;
                        scoreEl.textContent = matchData.players[index].score;
                        if (matchData.players[index].isWinner) {
                            nameEl.classList.add('winner');
                        }
                    });
                    match.classList.add('summary-match', 'match-completed');
                    match.querySelectorAll('button, .score-controls').forEach(el => el.remove());
                } else {
                    // Ocultar partidos no jugados en el resumen
                    match.style.opacity = '0.2';
                }
            });
            
            setTimeout(() => {
                bracketContainer.style.display = 'none';
                summaryContainer.style.opacity = '1';
                drawConnectors(); // Redibujar las llaves para el resumen
            }, 500);
        }

        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationFrameId;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        
        class Particle {
            constructor(x, y, color, scale) {
                this.x = x; this.y = y; this.color = color;
                this.size = (Math.random() * 2 + 1) * scale; this.alpha = 1;
                this.angle = Math.random() * Math.PI * 2;
                this.speed = Math.random() * (5 * scale) + 1; this.gravity = 0.1 * scale;
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vy += this.gravity; this.alpha -= 0.02;
            }
            draw() {
                ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }

        function createExplosion(x, y, scale) {
            const particleCount = 100 * scale;
            const colors = ['#FFC700', '#FF0000', '#FFFFFF', '#00FFC3'];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle(x, y, colors[Math.floor(Math.random() * colors.length)], scale));
            }
        }
        
        function animateFireworks() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].draw(); particles[i].update();
                if (particles[i].alpha <= 0) particles.splice(i, 1);
            }
            animationFrameId = requestAnimationFrame(animateFireworks);
            if (particles.length === 0) {
                cancelAnimationFrame(animationFrameId);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function launchFireworks(x, y, scale = 1) {
            if (particles.length === 0) { // Inicia la animación solo si no está corriendo
                animateFireworks();
            }
            createExplosion(x, y, scale);
        }

        const svg = document.getElementById('connector-svg');
        const bracketContainer = document.getElementById('bracket-container');
        const bracket = document.getElementById('bracket');

        function drawConnectors() {
            svg.innerHTML = ''; 
            const containerRect = bracketContainer.getBoundingClientRect();

            document.querySelectorAll('.match[data-next-match]').forEach(match => {
                const nextMatchId = match.dataset.nextMatch;
                const nextMatch = document.querySelector(`.match[data-match-id='${nextMatchId}']`);
                if (!nextMatch) return;

                const startRect = match.getBoundingClientRect();
                const endRect = nextMatch.getBoundingClientRect();
                
                const isRightWing = match.closest('.bracket-wing.right');

                const startX = (isRightWing ? startRect.left : startRect.right) - containerRect.left + bracketContainer.scrollLeft;
                const startY = startRect.top + startRect.height / 2 - containerRect.top;
                
                const endX = (isRightWing ? endRect.right : endRect.left) - containerRect.left + bracketContainer.scrollLeft;
                const endY = endRect.top + endRect.height / 2 - containerRect.top;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const horizontalLineLength = 48;
                const midX = isRightWing ? startX - horizontalLineLength : startX + horizontalLineLength;
                const d = `M ${startX} ${startY} L ${midX} ${startY} L ${midX} ${endY} L ${endX} ${endY}`;
                
                path.setAttribute('d', d);
                path.setAttribute('stroke', '#9CA3AF');
                path.setAttribute('stroke-width', '3');
                path.setAttribute('fill', 'none');
                svg.appendChild(path);
            });
            svg.setAttribute('width', bracket.scrollWidth);
            svg.setAttribute('height', bracket.scrollHeight);
        }

        window.addEventListener('load', () => {
             drawConnectors();
             resizeCanvas();
        });
        window.addEventListener('resize', () => {
            drawConnectors();
            resizeCanvas();
        });

    </script>
</body>
</html>
